네트워크 계층(Network Layer)

1. 정의

- 인터넷 계층이라고도 불림.
- 통신 방법(케이블의 차이라던가..)의 차이를 흡수하는 기능, "누가 누구에게 전달"할지에 대한 정보를 다룬다.
- 트랜스포트 계층의 세그먼트는 네트워크 계층에서 데이터라고 불리고, IP헤더가 붙으면 **IP데이터그램**이라고 불린다.
- IP헤더에는 목적지를 특정하는 번호(IP주소)가 있다.
- 목적지까지 경로가 여러개 있는 경우, 적절한 경로로 전달하는 역할도 한다.(라우터 이용)

2. 프로토콜의 종류

(1) IP

- 비커넥션 프로토콜 => 일단 보내면 OK!, 상대한테 전달됬는지 신경쓰지 않음. => 그래서 신뢰성 있는 IP가 되기 위해 지원하는 **ICMP**가 존재.
- IP데이터 전송은 **Best Effort방식**
  \*Best Effort란? 노력은 하지만 결과는 보장하지 않는다. 재전송하지는 않음, 목적지주소가 있는지 없는지나 헤더 상태 판단 처리는 해줌.
- 송신측에서는 최적의 경로로 전달.(목적지에 빨리 도달하도록 함.)
- 수신측에서는 목적지 주소 확인 후(IP주소 확인 후), 자기 앞으로 온 것만 받는다. 그리고 트랜스포트 계층의 지정된 프로토콜에 전달한다.

  a. IPv4

- 32비트로, 8비트씩 구분하고 10진수로 바꿔서 표현하기도 한다.
- 네트워크부, 호스트부로 구성되어 있다. => 이 둘의 경계를 나타내는 것이 **서브넷 마스크**로 네트워크부는 1로 호스트부는 0으로 나타낸다.
- 네트워크부란? 고유의 번호가 들어간다. \*라우터는 접속되어 있는 네트워크 수만큼 IP주소를 가지고 있다.  
  ex) 39.54.23.12/16, 63.54.145.34/16, 79.54.100.75/16 이렇게 네트워크부가 다른 IP가 3개가 있다면, 라우터는 3개가 존재한다.  
  why? 라우터는 **네트워크가 다른 기기 간에 통신**을 할 수 있도록 도와주는 기기역할을 해주기 때문이다. 만약에 **네트워크부가 같다면 라우터가 없이도** 기기들끼리 그냥 통신이 가능하다. 그러나 네트워크가 다르다면 같은 네트워크 안에 속해있지 않으므로 네트워크 간에 연결을 해서 전달해주는 게 필요한데 그게 바로 라우터가 해주는 것이다.  
  사실1) 만약 하나의 공유기(wifi)에 여러 컴퓨터를 연결해서 IP를 확인해보면 다 같은 IP주소를 갖는다.  
  사실2) 핸드폰의 데이터를 껐다켰다해보면 IP주소가 계속 바뀐다.
- 호스트부란? 각각의 컴퓨터를 나타내는 번호가 들어간다. 자유롭게 할당이 가능.(전부 0이거나 전부 1은 불가능)  
  => 즉 네트워크부와 호스트부를 합한 IP는 인터넷 내에서 전체에 개인을
- ex) 192.168.15.10 (10진수) => 1100000 10101000 00001111 00001010 (2진수)  
   서브넷마스크가 255.255.0.0 (10진수) => 11111111 11111111 00000000 00000000 (2진수) 라면 네트워크부와 호스트부가 16비트씩 나눠 가졌음을 알 수 있다.
  서브넷 마스크 표기 시, 192.168.15.10/16 이렇게 슬래시를 나타내어 네트워크부의 비트수를 표현하기도 한다. 16이므로 네트워크부의 비트수가 16비트임을 알 수 있다.
- 맨 앞은 네트워크 주소로, 맨 마지막은 브로드캐스트 주소로 사용된다.  
   ex) 192.168.15.10 (10진수), 서브넷마스크가 255.255.0.0 (10진수) 이면  
   네트워크 주소 => 192.168.0.0 이는 192.168.0.1 ~ 192.168.255.254의 IP들의 네트워크 주소이다. 대표 주소랄까?  
   브로드캐스트 주소 => 192.168.255.255 => 이걸로 전송하면 같은 네트워크에 있는 컴퓨터들에 한 번에 데이터 전부 전송

 <p align="center">
   <img src="https://github.com/goodlucky1215/CS_Study/blob/main/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/tcp_ip%EA%B3%84%EC%B8%B5(5%EA%B3%84%EC%B8%B5)/%EC%82%AC%EC%A7%84/3.%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/IPv4_header.png"
     width="600"
     height="300" />

- IPv4헤더 설명  
   A.버전(4비트) : IP버전을 의미한다.  
   ex) IPv4의 경우 4가 들어간다.  
   B. IP헤더의 크기  
   C. 서비스 타입(8비트) : 서비스의 품질  
   D. 패킷 길이(16비트) : IP헤더와 IP데이터의 합계 바이트수  
   E. 식별자(16비트) : 분할된 IP데이터그램을 복원할 때 사용하는 값  
   F. 서비스 타입(3비트) : 패킷 분할과 관련된 정보  
   G. 플래그먼트 오프셋(133비트) : 분할된 데이터의 순서  
   H. 생존 시간(8비트) : 통과할 수 있는 라우터의 수  
   I. 프로토콜(8비트) : 상위 프로토콜  
   J. 헤더 체크섬(16비트) : IP헤더가 무사한지 아닌지를 확인하는 값  
   K. 송신측IP주소(32비트) / 수신측IP주소(32비트)  
   L. 옵션 : 보통 사용하지 않음  
   M. 패딩 : 헤더가 32비트 정수배가 되지 않을 때 0을 덧붙여서 헤더의 크기를 조정

  b. IPv6

- 128비트로, 16비트마다 :(콜론)으로 구분하고 16진수(0~f)로 표기한다.
- IPv4가 나타낼 수 있는 IP주소는 약 43억 개로 부족해지기 시작하여, IPv6가 등장했다.
- ex) 2001:2df6:1ee9:05f0:0000:0000:0000:0019 (16진수) => :을 기준으로 16비트씩 8개로 나누고 있다. 여기서 저 하나의 자리당 4비트씩을 의미한다.(4비트가(2의 4승) 16진법을 나타낼 수 있으니깐!!)
- 규칙
  a. :(콜론)의 필드의 선두는 0이 있을 경우 생략이 가능하다. (단, 필드가 모두 0인 경우는 0 하나를 남겨놔야 한다.)
  ex) 2001:2df6:1ee9:05f0:0000:0000:0000:0019 => 2001:2df6:1ee9:5f0:0:0:0:19
  b. 0인 필드가 연속되는 경우는 0을 생략할 수 있다. 그러나 그런 구간이 여러개인 경우 **한 번만** 이용할 수 있다.
  ex) 2001:2df6:1ee9:05f0:0000:0000:0000:0019 => 2001:2df6:1ee9:5f0::19
  ex) 2001:0000:0000:05f0:0000:0000:0000:0019 => 2001:0:0:5f0::19 또는 2001::5f0:0:0:0:19  
  서브넷 마스크 표기 시, 2001:2df6:1ee9:5f0::19/64 이렇게 슬래시를 나타내어 네트워크부의 비트수를 표현하기도 한다. 64이므로 네트워크부의 비트수가 64비트임을 알 수 있다.

  <p align="center">
    <img src="https://github.com/goodlucky1215/CS_Study/blob/main/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/tcp_ip%EA%B3%84%EC%B8%B5(5%EA%B3%84%EC%B8%B5)/%EC%82%AC%EC%A7%84/3.%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/IPv6_header.png"
      width="600"
      height="300" />

- IPv6헤더 설명  
   A.버전(4비트) : IP버전을 의미한다.  
   ex) IPv6의 경우 6이 들어간다.  
   B. 트래픽 클래스(8비트) : 전송 시, 우선도  
   C. 플로우 레이블(20비트) : 통신 경로의 품질을 확보하거나 경로의 우선적인 선택을 위해 사용  
   D. 페이로드 길이(16비트) : IP헤더를 제외한 확장 헤더와 데이터의 합계 크기  
   E. 넥스트 헤더(8비트) : 다음에 이어지는 확장 헤더와 상위 프로토콜의 타입을 나타냄  
   F. 홉 제한(8비트) : 통과할 수 있는 라우터의 수  
   G. 송신측IP주소(128비트) / 수신측IP주소(128비트)

(2) ICMP(Internet Control Message Protocol)

- 수신 측에 전달되지 않는 등의 문제가 발생할 때, 송신 측에 메시지를 보냄. => ICMP헤더와 ICMP데이터에 IP헤더를 붙인 형태로 송신측에 보낸다.
- IP와 ICMP는 TCP와 UDP처럼 병렬적인 관계가 아님! ICMP는 어디까지나 IP를 도와주는 프로토콜이다.
- IPv6에서는 ICMPv6를 사용

  <p align="center">
    <img src="https://github.com/goodlucky1215/CS_Study/blob/main/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/tcp_ip%EA%B3%84%EC%B8%B5(5%EA%B3%84%EC%B8%B5)/%EC%82%AC%EC%A7%84/3.%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/ICMP_header.png"
      width="700"
      height="100" />

- ICMP헤더 설명  
   A. 타입(8비트) : 메시지의 종류를 나타내는 숫자  
   ex) ICMP에서 3, ICMPv6에서 1 => IP대이터그램을 목적지에 전달할 수 없음을 의미.  
   ex) ICMP에서 5, ICMPv6에서 137 => 현재 경로보다 최적의 경로를 찾음  
   B. 코드(8비트) : 오류의 원인 등을 나타내는 숫자  
   C. 체크섬(16비트) : 데이터가 무사한지 아닌지를 확인하기 위한 값
- 접속 상태를 조사하는 명령어(특정 컴퓨터가 네트워크 상에 존재하는지 여부를 조사) ping / 목적지까지의 경로를 조사하는 명령어 tracert(UNIX에서는 traceroute) => 이 둘 다 ICMP메세지를 사용해서 결과를 반환한다.
- tracert 예시

  <p align="center">
    <img src="https://github.com/goodlucky1215/CS_Study/blob/main/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/tcp_ip%EA%B3%84%EC%B8%B5(5%EA%B3%84%EC%B8%B5)/%EC%82%AC%EC%A7%84/3.%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/tracert_%EB%AA%A8%EC%9E%90%EC%9D%B4%ED%81%AC.png"
      width="700"
      height="300" />

a. 그림과 같이 구글홈페이지에 대한 위치 추정을 해봄.(tracert www.google.com)
b. 1번의 3가지는 통신에 걸린 시간을 의미한다. 평균 결과를 얻기 위해 3번의 시간 조사를 한 것이다.  
 => IP데이터그램을 보내서 ICMP메시지가 다시 송신쪽으로 되돌아오기까지의 시간을 조사한 것이다.  
 => 5번째와같이 시간이 \* \* \* 으로 되어 있고 시간이 만료되었다는 문구가 뜬 것은 일부러 방화벽으로 막아둔 것일 수도 있다.
c. 2번은 통신 상대의 컴퓨터이다. 위의 순서대로 경유지를 거쳐서 맨 밑에 최종 목적지인 구글 홈페이지까지 도달한 것을 볼 수 있다.  
 \*여기서 IP헤더에 "생존 시간" 항목에 수를 적는데, 이 숫자가 통과할 수 있는 라우터의 갯수를 의미한다. 만약 내가 생존시간을 5로 해두었다면, 그림에서 구글까지 9홉수(9개의 라우터가 필요하므로)가 필요하므로 목적지까지 전달되지 않을 것이다. => 라우터가 경유지를 통과 할때마다 생존 시간이 1씩 줄어든다.

(3) DHCP(Dynamic Host Configuration Protocol)

- 자동으로 IP주소를 할당하는 프로토콜 => 만약 고정IP주소를 할당하고 싶다면? 개별적으로 설정하면 됨.
- 이건 **사설 주소**를 자동으로 할당해주는 것임! => 공인 주소는 NAT, NAPT(PAT)  
  Tip) 집이나 사무실에서 사용하는 가정용 라우터인 인터넷 공유기에도 DHCP 기술이 적용되어 있다. 그래서 컴퓨터나 핸드폰 와이파이를 켜면 cmd창에서 ipconfig로 확인 시 나오는 IPv4역시 공유기가 DHCP 기술로 자동 할당해 준 것이다.
- IP주소 요청 과정
  a. DHCP클라이언트 : IP주소 주세요. 이때 클라이언트IP주소를 0.0.0.0(255.255.255.255)로 만듬. 이것을 브로드캐스트 주소라고 한다.
  b. 동일한 LAN안의 **모든 기기에게 송신**이 된다. (즉 요청이 이뤄진다.) 그러나 이 요청에 대해서는 **DHCP서버만이 응답한다.**
  c. DHCP서버 : 사용할 IP주소를 전달한다.(응답)
  d. DHCP클라이언트 : IP주소를 부여받으면, 다시 0.0.0.0(255.255.255.255)로 확인 메세지를 보내준다.
  e. 또 다시, 동일한 LAN안의 **모든 기기에게 송신**이 된다. (즉 요청이 이뤄진다.) 그러나 이 요청에 대해서는 **DHCP서버만이 응답한다.**
  f. DHCP서버 : 마지막으로 알겠다는 응답 메세지를 보내면서 종료된다.

3. 서브넷

- 127.15.4.0 ~ 127.15.4.255/24 까지 하면 하나의 네트워크에 254대의 기기가 접속할 수 있다.(0과 255는 고유주소로 사용할 수 없다. 0은 네트워크 주소고 255는 브로드캐스트 주소로 쓰인다.) => 그러나 이렇게 네트워크가 많이 필요하지 않은 경우가 많다 그래서 **서브넷**이라는 장치를 사용해 가상으로 작은 네트워크들을 만들어 네트워크 모음으로 처리한다.
- 서브넷은 가상으로 네트워크부를 늘린다. => 127.15.4.0 ~ 127.15.4.255/28 (4비트의 네트워크부를 증가시켰다) => 그러면 16개의 기기를 접속할 수 있는 네트워크를 16개 만들 수 있다. => 밖에서 보면 큰 네트워크로 보이겠지만, 네트워크 안에서는 서브넷으로 또 쪼개져있다.
- 서브넷을 사용하면, 회사 등과 같이 네트워크 규모가 큰 경우 부서나 계층 단위로 관리하기가 쉬워진다.

4. 사설 주소(내부IP)

- 사설 주소는 회사 내나 가정 내 등 한정된 네트워크 안에서만 유효한 IP주소로 사설주소라고 한다. 이는 다른 네트워크에서는 통용되지 않기 때문에, 네트워크가 다르면 중복되어도 문제가 없다.  
  => 사설 주소로 사용 가능한 범위가 있는데 이 범위의 주소는 공인 주소로 사용하지 않는다.
  => **10.0.0.0~10.255.255.255  
   172.16.0.0~172.31.255.255  
   192.168.0.0~192.168.255.255 사설 주소로 사용 된다.**
  => 공인 주소(외부IP)는 중복 될 수 없다!!
- NAT(Network Address Translation) : 사설 주소와 공인 주소를 일대일 대응
  a. Static NAT : 사설IP와 공인 IP를 1:1 매핑 (똑같은 갯수만큼 필요하므로 사용하는 것에 그닥 의미가 없음)  
  b. Dynamic NAT : 다수 공인 IP와 다수 사설 IP 매핑. 공인IP가 다 사용 중 일시, 비어지고 나서 사설IP가 공인IP로 매핑하여 접속.  
  Q) 사설 주소와 공인 주소 확인 방법은? 사설 주소는 cmd창에 ipconfig를 치면 IPv4주소를 보면 되고(신기하게도 진짜 사설 주소 대역으로만 사용되는 ip주소를 확인할 수 있을 것이다.), 공인 주소는 네이버 검색 창에 "ip 주소 확인" 이라고 치면 나온다.
- NAPT(또는 PAT 또는 IP 매스커레이드, Network Address Port Translation) : 하나의 공인 주소로 여러 사설 주소의 기기들을 접속할 수 있다. 이때 포트 번호로 이 기기들을 구분한다. => 응답을 받을 때, 하나의 공인 주소를 사용해도 서로 다른 포트를 가지고 있으므로 응답을 받을 때 구분해서 받을 수 있다.
  TIP) NAT는 주소 변환 기술이고 주로 라우터에 의해 구현된다. 집이나 사무실에서 사용하는 가정용 라우터인 인터넷 공유기에도 NAT 또는 NAPT 기술이 적용되어 있다. (보통 NAPT을 사용. 포트만 바꾸면 되니깐)
  Q) 만약 외부에서 내부로 접속하고 싶다면?  
  a. 포트포워딩 : 공인IP의 포트를 사설IP마다 할당해서 사용하는 방법  
  b. DMZ : 공인IP의 모든 포트를 특정 사설IP에 전부 몰아주는 방법

5. IPsec(IP security)

- IP데이터그램의 인증이나 암호화를 수행하는 프로토콜을 총칭이다.

6. 공유기

- 이는 방화벽을 가지고 있음.
- 2계층 스위치, 3계층 라우터, 4계층 NAT, 무선AP까지 보통 갖추고 있다.
